<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <!-- Include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <!-- Include jsPDF-AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
        <script>
            console.log("jsPDF foi carregado:", typeof jsPDF !== 'undefined');
        </script>
</head>
<body>
    <div class="grid-container">
        <div class="grid-item1">
            <img class="logoh" src="https://i.im.ge/2024/04/04/WEcTRc.logo-sem-fundo.png" alt="Logo">
            <div class="user-photo-container">
                <img src="https://img.freepik.com/psd-gratuitas/ilustracao-3d-de-avatar-ou-perfil-humano_23-2150671142.jpg?size=338&ext=jpg" alt="User photo" class="user-photo">
                <div class="cinfo"><p class="pinfo">caixa de informação</p></div>
            </div>
            <nav class="menu">    
                <ul class="menu">
                    <li class="btnmenu"><a class="a2" href="ger-hor.html">HORÁRIOS</a></li>
                    <li class="btnmenu"><a class="a2" href="ger-user.html">USUÁRIOS</a></li>
                    <li class="btnmenu"><a class="a2" href="ger-rot.html">ROTAS</a></li>              
                    <li class="btnmenu"><a class="a2" href="index.html">SAIR</a></li>
                </ul>   
            </nav>            
        </div>
        <div class="grid-item2">
            <h1 class="arger">Área de Gerenciamento de Usuários</h1>
            <div class="boxtab">
                <div class="cabetab">
                    <p class="pcabe">
                        <button id="selectAllButton" onclick="toggleSelectAll()">Selecionar Todos</button>
                        <button id="gePdf" onclick="generatePDF()">Gerar PDF</button>
                        <input type="text" name="pesquisa_por_nome" id="pesNome" placeholder="Pesquisa por nome">
                        <button id="btnPesNome"><i class="fas fa-search"></i> Pesquisa</button>
                    </p>
                    <p class="pcabe">
                        <input type="text" name="pesquisa_por_cpf" id="pesCpf" placeholder="Pesquisa por CPF">
                        <button id="btnPesCpf"><i class="fas fa-search"></i> Pesquisa</button>
                    </p>
                </div>
                <div class="scrollable-table-container">
                    <table id="tab12" class="table table-dark">
                        <thead>
                            <tr>
                                <th>Seleção</th>
                                <th>CPF</th>
                                <th>Email</th>
                                <th>Instituição</th>
                                <th>Nome</th>
                                <th>Senha</th>
                                <th>Cidade Cadastrada</th>
                                <th>Documento</th>
                                <th>Ações</th>
                                <th>Registrar</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <button class="btnfun"><i class="fa-solid fa-plus"></i> <a class="a2" href="cadastrouser.html">Adicionar</a></button>
            </div>
            <!-- Popup para edição -->
            <div id="editPopup" class="popup">
                <div class="popup-content">
                    <img class="logohpop" src="https://i.im.ge/2024/04/04/WEcTRc.logo-sem-fundo.png" alt="Logo Popup">
                    <input type="hidden" id="editKey">
                    <input type="text" class="editpop" id="editCpf" placeholder="Novo CPF">
                    <input type="text" class="editpop" id="editEmail" placeholder="Novo Email">
                    <input type="text" class="editpop" id="editInstituicao" placeholder="Nova Instituição">
                    <input type="text" class="editpop" id="editNome" placeholder="Novo Nome">
                    <input type="text" class="editpop" id="editSenha" placeholder="Nova Senha">
                    <input type="text" class="editpop" id="editCidade" placeholder="Nova Cidade">
                    <input class="boxcads" name="file" id="casfile" type="file" placeholder="Anexar Arquivo">                   
                    <button id="saveButton" onclick="saveChanges()">Salvar</button>
                    <button id="cancelButton" onclick="closeEditPopup()">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="error-message" style="color: red; margin-top: 10px; display: none;"></div>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyD26pWZ9AMYoisXfrtm7038K2SuuXuWkr8",
                authDomain: "glor-ae49f.firebaseapp.com",
                databaseURL: "https://glor-ae49f-default-rtdb.firebaseio.com",
                projectId: "glor-ae49f",
                storageBucket: "glor-ae49f.appspot.com",
                messagingSenderId: "677710403853",
                appId: "1:677710403853:web:f67284b068399eebb97844"
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();
            const storage = firebase.storage();

            // Event listeners for search buttons
            document.getElementById('btnPesNome').addEventListener('click', () => {
                const pesquisaNome = document.getElementById('pesNome').value.trim();
                if (pesquisaNome !== '') {
                    searchByField('nome', pesquisaNome);
                }
            });

            document.getElementById('btnPesCpf').addEventListener('click', () => {
                const pesquisaCpf = document.getElementById('pesCpf').value.trim();
                if (pesquisaCpf !== '') {
                    searchByField('cpf', pesquisaCpf);
                }
            });

            document.getElementById('pesNome').addEventListener('input', () => {
                if (document.getElementById('pesNome').value.trim() === '') {
                    getAllDataOnce();
                }
            });

            document.getElementById('pesCpf').addEventListener('input', () => {
                if (document.getElementById('pesCpf').value.trim() === '') {
                    getAllDataOnce();
                }
            });

            function searchByField(field, value) {
                db.ref("usuarios").orderByChild(field).equalTo(value).once('value')
                    .then(snapshot => {
                        const users = [];
                        snapshot.forEach(childSnapshot => {
                            const user = childSnapshot.val();
                            if (typeof user === 'object' && user !== null) {
                                user.key = childSnapshot.key;
                                users.push(user);
                            } else {
                                console.error("Expected object, but got:", user);
                            }
                        });
                        addAllItemsToTable(users);
                    })
                    .catch(error => {
                        console.error("Erro ao obter os dados: ", error);
                    });
            }

            function getAllDataOnce() {
                db.ref("usuarios").once('value')
                    .then(snapshot => {
                        const users = [];
                        snapshot.forEach(childSnapshot => {
                            const user = childSnapshot.val();
                            if (typeof user === 'object' && user !== null) {
                                user.key = childSnapshot.key;
                                users.push(user);
                            } else {
                                console.error("Expected object, but got:", user);
                            }
                        });
                        addAllItemsToTable(users);
                    })
                    .catch(error => {
                        console.error("Erro ao obter os dados: ", error);
                    });
            }

            function addItemToTable(user) {
                const tbody = document.getElementById('tbody1');
                const tr = document.createElement('tr');

                tr.innerHTML = `
                    <td><input type="checkbox"></td>
                    <td>${user.cpf}</td>
                    <td>${user.email}</td>
                    <td>${user.instituicao}</td>
                    <td>${user.nome}</td>
                    <td>${user.senha}</td>
                    <td>${user.cidade}</td>
                    <td><button onclick="openDocumentLink('${user.fileURL}')">Documento</button></td>
                    <td>
                        <button onclick="editItem('${user.key}', '${user.cpf}', '${user.email}', '${user.instituicao}', '${user.nome}', '${user.senha}', '${user.cidade}')">Editar</button>
                        <button onclick="deleteItem('${user.key}')">Excluir</button>
                    </td>
                    <td><button onclick="registerUser('${user.key}', '${user.email}', '${user.senha}')">Registrar</button></td>
                `;
                tbody.appendChild(tr);
            }

            function editItem(key, cpf, email, instituicao, nome, senha, cidade) {
                document.getElementById('editKey').value = key;
                document.getElementById('editCpf').value = cpf;
                document.getElementById('editEmail').value = email;
                document.getElementById('editInstituicao').value = instituicao;
                document.getElementById('editNome').value = nome;
                document.getElementById('editSenha').value = senha;
                document.getElementById('editCidade').value = cidade;
                document.getElementById('editPopup').style.display = 'block';
            }

            function closeEditPopup() {
                document.getElementById('editPopup').style.display = 'none';
            }

            function saveChanges() {
                const key = document.getElementById('editKey').value;
                const cpf = document.getElementById('editCpf').value;
                const email = document.getElementById('editEmail').value;
                const instituicao = document.getElementById('editInstituicao').value;
                const nome = document.getElementById('editNome').value;
                const senha = document.getElementById('editSenha').value;
                const cidade = document.getElementById('editCidade').value;
                const file = document.getElementById('casfile').files[0];

                if (file) {
                    const storageRef = storage.ref().child(`documents/${key}/${file.name}`);
                    storageRef.put(file).then(() => {
                        storageRef.getDownloadURL().then(url => {
                            db.ref("usuarios").child(key).update({
                                cpf, email, instituicao, nome, senha, cidade, documentoUrl: url
                            });
                            closeEditPopup();
                            getAllDataOnce();
                        });
                    }).catch(error => {
                        console.error("Erro ao fazer upload do arquivo:", error);
                    });
                } else {
                    db.ref("usuarios").child(key).update({ cpf, email, instituicao, nome, senha, cidade })
                        .then(() => {
                            closeEditPopup();
                            getAllDataOnce();
                        })
                        .catch(error => {
                            console.error("Erro ao salvar as alterações:", error);
                        });
                }
            }

            function deleteItem(key) {
                db.ref("usuarios").child(key).remove()
                    .then(() => {
                        getAllDataOnce();
                    })
                    .catch(error => {
                        console.error("Erro ao excluir o item:", error);
                    });
            }

            function registerUser(key, email, senha) {
                auth.createUserWithEmailAndPassword(email, senha)
                    .then(userCredential => {
                        const user = userCredential.user;
                        db.ref("usuarios").child(key).update({ uid: user.uid });
                        alert("Usuário registrado com sucesso!");
                    })
                    .catch(error => {
                        if (error.code === 'auth/email-already-in-use') {
                            document.getElementById('error-message').textContent = "Este endereço de e-mail já está em uso por outra conta.";
                            document.getElementById('error-message').style.display = 'block';
                        } else {
                            document.getElementById('error-message').textContent = "Ocorreu um erro ao registrar o usuário.";
                            document.getElementById('error-message').style.display = 'block';
                        }
                    });
            }

            function addAllItemsToTable(users) {
                const tbody = document.getElementById('tbody1');
                tbody.innerHTML = '';
                users.forEach(user => addItemToTable(user));
            }

            function toggleSelectAll() {
                const checkboxes = document.querySelectorAll('#tbody1 input[type="checkbox"]');
                const selectAllButton = document.getElementById('selectAllButton');
                const selectAll = selectAllButton.textContent === 'Selecionar Todos';
                checkboxes.forEach(checkbox => checkbox.checked = selectAll);
                selectAllButton.textContent = selectAll ? 'Deselecionar Todos' : 'Selecionar Todos';
            }

            function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Adiciona um título ao PDF
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.text("Relatório de Usuários", 10, 10);

            // Estiliza e adiciona a tabela
            doc.autoTable({

                html: '#tab12',
                startY: 20, // A posição Y inicial da tabela
                columns: [
                    { header: 'Nome', dataKey: 'Nome' },
                    { header: 'Email', dataKey: 'email' },
                    {header:  'instituicao', dataKey: 'instituicao'},
                    {header: 'cidade', dataKey: 'cidade'},
                    {header: '', dataKey: ''},

                ],

                html: '#tab12',
                startY: 20, // A posição Y inicial da tabela
                styles: {
                    fontSize: 12,
                    cellPadding: 5,
                    halign: 'center', // Alinhamento horizontal das células
                    valign: 'middle', // Alinhamento vertical das células
                    lineColor: [44, 62, 80], // Cor das linhas das células
                    lineWidth: 0.1 // Espessura das linhas das células
                },
                headStyles: {
                    fillColor: [22, 160, 133], // Cor de fundo do cabeçalho
                    textColor: 255,            // Cor do texto do cabeçalho
                    fontStyle: 'bold'          // Estilo da fonte do cabeçalho
                },
                bodyStyles: {
                    fillColor: [255, 255, 255], // Cor de fundo do corpo
                    textColor: 0               // Cor do texto do corpo
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240] // Cor de fundo das linhas alternadas
                },
                margin: { top: 20 } // Margem superior
            });

            // Adiciona um rodapé
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text('Página ' + String(i) + ' de ' + String(pageCount), 10, 290);
            }

            // Salva o PDF
            doc.save('usuarios.pdf');
        }
            function openDocumentLink(documentURL) {
                window.open(documentURL, '_blank');
            }

            window.onload = getAllDataOnce;
        </script>
    </div>
</body>
</html>
